<base href="..">

<link rel="import" href="bower_components/protoboard/out/check.html">
<link rel="import" href="bower_components/protoboard/out/service/acl.html">
<link rel="import" href="bower_components/protoboard/out/service/log.html">
<link rel="import" href="bower_components/protoboard/out/service/move.html">
<link rel="import" href="bower_components/protoboard/out/service/state.html">
<link rel="import" href="bower_components/protoboard/out/third_party/events.html">
<link rel="import" href="bower_components/protoboard/out/third_party/jquery.html">
<link rel="import" href="bower_components/protoboard/out/utils.html">

<link rel="import" href="src/dijs.html">
<link rel="import" href="src/helper.html">
<link rel="import" href="src/ui.html">

<script type="text/javascript">
  DI
      .prefix('gz')
      .bind(
          'logic',
          {
            $: '/=',
            Acl: '/pb.service.=',
            Check: '/pb.=',
            Events: '/pb.=',
            helper: '=',
            Log: '/pb.service.=',
            Move: '/pb.service.=',
            State: '/pb.service.=',
            ui: '=',
            Utils: '/pb.=',
          },
          function($i) {

    function nextTurn(ui) {
      // Change the turn
      var turn = $i.Check($i.State.get('turn')).isInt().orThrows() + 1;
      $i.Log.log('turn', turn);
      $i.State.put('turn', turn);

      // Switch the current player
      if ($i.Acl.currentPlayer === 'player1') {
        $i.Acl.currentPlayer = 'player2';
      } else {
        $i.Acl.currentPlayer = 'player1';
      }
    }

    function onMove(event, details) {
      var fromEl = details.from;
      var toEl = details.to;
      var movedEl = details.moved;
      var movedId = $i.$(movedEl).attr('pb-id');

      if ($i.helper.isPlayerDeck(fromEl) && $i.helper.isPlayerHand(toEl)) {
        $i.Log.log('draw', movedId);
      } else if ($i.helper.isDraftDeck(fromEl) && $i.helper.isPlayerDiscard(toEl)) {
        $i.Log.log('draft', movedId);
      } else if ($i.helper.isPlayerHand(fromEl)
          && $i.helper.isPlayArea(toEl)
          && $i.helper.isFlipped(movedEl)) {
        $i.Log.log('transmute', movedId);
      } else if ($i.helper.isDraftDeck(fromEl) && $i.helper.isDraftDiscard(toEl)) {
        $i.Log.log('replace', movedId);
      }
    }

    return function(document) {
      var ui = $i.ui(document);
      ui.forPlayers().getArea().async()
          .then(function(playerAreas) {
            playerAreas.forEach(function(area) {
              $i.Acl.registerElement(area);
            });
          });

      ui.forPlayers()
          .getDraw4Button()
          .getShuffleIntoDeckButton()
          .async()
          .then(function(els) {
            els.forEach(function(el) {
              el.addEventListener('click', nextTurn.bind(null, ui));
            });
          });

      $i.Events.of($i.Move)
          .on('jquery', $i.Move.Events.MOVE, onMove);
    };
  });
</script>
